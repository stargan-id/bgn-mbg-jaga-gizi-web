# Setup MapKit JS untuk Peta SPPG

## Overview

Halaman Peta SPPG menggunakan Apple MapKit JS untuk menampilkan peta interaktif dengan marker SPPG di seluruh Indonesia. MapKit JS memerlukan JWT token untuk autentikasi.

## Konfigurasi Apple Developer Account

### 1. Daftar Apple Developer Program
- Daftar di [Apple Developer Program](https://developer.apple.com/programs/)
- Biaya: $99/tahun untuk individual atau organization

### 2. Buat Maps Identifier
1. Login ke [Apple Developer Console](https://developer.apple.com/account/)
2. Go to **Certificates, Identifiers & Profiles**
3. Pilih **Identifiers** → **App IDs**
4. Klik **+** untuk create new identifier
5. Pilih **Maps IDs**
6. Masukkan:
   - **Description**: "JAGA GIZI Web Maps"
   - **Identifier**: `id.jagagizi.maps` (atau sesuai convention Anda)
7. Save identifier

### 3. Create Signing Key
1. Di Apple Developer Console, go to **Keys**
2. Klik **+** untuk create new key
3. Masukkan:
   - **Key Name**: "JAGA GIZI MapKit JS Key"
   - **Services**: Centang **MapKit JS**
4. Click **Continue** → **Register**
5. **Download** file `.p8` (contoh: `AuthKey_ABC123DEF4.p8`)
6. **Catat Key ID** (contoh: `ABC123DEF4`)
7. **Catat Team ID** dari Account summary page

## Environment Configuration

### 1. Copy Environment File
```bash
cp .env.example .env.local
```

### 2. Update MapKit Configuration di `.env.local`
```env
# Apple MapKit JWT Generation Configuration
MAPKIT_TEAM_ID="YOUR_TEAM_ID_HERE"
MAPKIT_KEY_ID="YOUR_KEY_ID_HERE"
MAPKIT_PRIVATE_KEY_PATH="./AuthKey_YOUR_KEY_ID.p8"
MAPKIT_ORIGIN="http://localhost:3000"

# Generated JWT Token (will be generated by script)
MAPKIT_JWT=""
NEXT_PUBLIC_MAPKIT_JS_TOKEN=""
```

### 3. Copy Private Key File
Copy file `.p8` yang di-download ke root directory project:
```bash
# Contoh:
AuthKey_ABC123DEF4.p8
```

## Generate JWT Token

### Method 1: Menggunakan Script (Recommended)
```bash
pnpm mapkit:generate-jwt
```

Script akan:
- ✅ Validate konfigurasi environment
- ✅ Generate JWT token dengan expiry 30 hari
- ✅ Display token untuk copy ke `.env.local`

### Method 2: Manual Configuration
Jika ingin menggunakan private key sebagai string di environment variable:

1. Convert `.p8` file ke string:
```bash
# Di terminal/command prompt:
cat AuthKey_YOUR_KEY_ID.p8
```

2. Copy output dan paste ke `.env.local`:
```env
MAPKIT_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
YOUR_PRIVATE_KEY_CONTENT_HERE
-----END PRIVATE KEY-----"
```

## Development vs Production

### Development Mode
Jika MapKit token tidak dikonfigurasi, aplikasi akan menggunakan **MapPlaceholder** yang menampilkan:
- ✅ List SPPG dalam card format
- ✅ Color coding berdasarkan status
- ✅ Click handler untuk info overlay
- ✅ Semua functionality kecuali peta visual

### Production Mode
Dengan token yang valid:
- ✅ Apple Maps dengan kualitas tinggi
- ✅ Interactive markers dengan clustering
- ✅ Zoom, pan, dan map controls
- ✅ Smooth animations dan transitions

## Troubleshooting

### Error: "MapKit JS token not configured"
**Solution**: 
1. Pastikan `.env.local` sudah dikonfigurasi
2. Run `pnpm mapkit:generate-jwt`
3. Copy generated token ke environment variables

### Error: "Invalid signature"
**Solution**:
1. Pastikan Team ID, Key ID, dan Private Key sudah benar
2. Pastikan file `.p8` tidak corrupt
3. Regenerate JWT token

### Error: "Origin not allowed"
**Solution**:
1. Update `MAPKIT_ORIGIN` di `.env.local`:
   - Development: `http://localhost:3000`
   - Production: `https://yourdomain.com`
2. Regenerate JWT token

### Error: "Token expired"
**Solution**:
1. JWT token expire setelah 30 hari
2. Run `pnpm mapkit:generate-jwt` untuk generate token baru

## Token Security

### Environment Variables
- ✅ `NEXT_PUBLIC_MAPKIT_JS_TOKEN`: Client-side token (OK untuk expose)
- ❌ `MAPKIT_PRIVATE_KEY`: Server-side only (jangan expose)
- ❌ `MAPKIT_TEAM_ID`, `MAPKIT_KEY_ID`: Server-side only

### Best Practices
1. **Development**: Use `.env.local` (git ignored)
2. **Production**: Use environment variables di hosting platform
3. **Rotation**: Regenerate token monthly untuk security
4. **Monitoring**: Track token expiry dates

## Production Deployment

### Environment Setup
```env
# Production environment
MAPKIT_ORIGIN="https://jagagizi.yourdomain.com"
NEXT_PUBLIC_MAPKIT_JS_TOKEN="your_production_jwt_token"
```

### Automated Token Generation
Untuk CI/CD pipeline, bisa setup cron job untuk auto-regenerate token:
```bash
# Contoh cron job (monthly)
0 0 1 * * /path/to/your/project && pnpm mapkit:generate-jwt
```

## Cost Estimation

### Apple MapKit JS Pricing
- **Free Tier**: 25,000 map views per day
- **Paid Tier**: $0.50 per 1,000 additional views
- **Enterprise**: Custom pricing untuk high-volume

### Usage Estimation JAGA GIZI
- **Internal Users**: ~100 BGN staff × 50 views/day = 5,000 views/day
- **Regional Users**: ~500 regional staff × 20 views/day = 10,000 views/day
- **Total**: ~15,000 views/day (well within free tier)

## Alternative Fallback

Jika ada masalah dengan MapKit JS, system akan fallback ke **MapPlaceholder** yang tetap functional untuk:
- ✅ View SPPG list
- ✅ Search dan filter
- ✅ Click untuk detail
- ✅ All business logic

---

## Quick Start Checklist

- [ ] Apple Developer Account setup
- [ ] Maps Identifier created
- [ ] Signing Key generated dan downloaded
- [ ] `.env.local` dikonfigurasi dengan Team ID, Key ID
- [ ] Private key file copied ke project root
- [ ] `pnpm mapkit:generate-jwt` executed
- [ ] Token copied ke `NEXT_PUBLIC_MAPKIT_JS_TOKEN`
- [ ] Application tested dengan `pnpm dev`

**Status**: Ready for production with proper Apple MapKit JS configuration!